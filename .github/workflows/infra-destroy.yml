name: ðŸ’¥ Destruir Infraestructura

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Escribe "DESTRUIR" para confirmar'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  destroy-infrastructure:
    name: Eliminar AWS Infrastructure
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DESTRUIR'
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: ðŸ” Configurar AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ðŸ“¦ Instalar AWS CDK
      run: npm install -g aws-cdk
    
    - name: ðŸ“š Instalar dependencias Go
      working-directory: infrastructure/cdk
      run: go mod download
    
    - name: ðŸ’¥ Destruir Infraestructura
      working-directory: infrastructure/cdk
      env:
        FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        GOOGLE_CLIENT_ID: ${{ vars.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      run: cdk destroy --force
    
    - name: âœ… ConfirmaciÃ³n
      run: |
        echo "### âš ï¸ Infraestructura Destruida" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Todos los recursos de AWS han sido eliminados." >> $GITHUB_STEP_SUMMARY
