name: ðŸ—ï¸ Crear Infraestructura

on:
  workflow_dispatch:  # Solo manual

env:
  AWS_REGION: eu-west-1

jobs:
  deploy-infrastructure:
    name: Desplegar AWS Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache-dependency-path: infrastructure/cdk/go.sum
    
    - name: ðŸ” Configurar AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ðŸ“¦ Instalar AWS CDK
      run: npm install -g aws-cdk
    
    - name: ðŸ“š Instalar dependencias Go
      working-directory: infrastructure/cdk
      run: go mod download
    
    - name: ðŸš€ Bootstrap CDK (si es necesario)
      working-directory: infrastructure/cdk
      run: |
        cdk bootstrap aws://${{ vars.AWS_ACCOUNT_ID }}/${{ env.AWS_REGION }} || echo "Ya bootstrapped"
    
    - name: ðŸ” CDK Synth
      working-directory: infrastructure/cdk
      env:
        FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        GOOGLE_CLIENT_ID: ${{ vars.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      run: cdk synth
    
    - name: ðŸ—ï¸ Desplegar Infraestructura
      working-directory: infrastructure/cdk
      env:
        FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
        GOOGLE_CLIENT_ID: ${{ vars.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      run: cdk deploy --require-approval never
    
    - name: ðŸ“Š Obtener Outputs
      run: |
        echo "### ðŸŽ‰ Infraestructura Desplegada" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        aws cloudformation describe-stacks \
          --stack-name DivtrackerStack \
          --query 'Stacks[0].Outputs' \
          --output table >> $GITHUB_STEP_SUMMARY
