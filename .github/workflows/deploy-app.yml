name: ðŸš€ Desplegar AplicaciÃ³n

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'infrastructure/**'
      - '**.md'
      - '.github/**'
  workflow_dispatch:  # TambiÃ©n manual

env:
  AWS_REGION: eu-west-1
  JAVA_VERSION: '17'

jobs:
  test-and-build:
    name: ðŸ§ª Tests y Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'corretto'
        cache: maven
    
    - name: ðŸ§ª Ejecutar Tests
      run: ./mvnw test
    
    - name: ðŸ“¦ Build JAR
      run: ./mvnw package -DskipTests
    
    - name: ðŸ’¾ Guardar JAR
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: target/divtracker-be.jar
        retention-days: 1
    
    - name: ðŸ’¾ Guardar archivos de deployment
      uses: actions/upload-artifact@v4
      with:
        name: deployment-files
        path: |
          Procfile
          .ebextensions/
        retention-days: 1

  deploy:
    name: ðŸš€ Deploy a AWS
    runs-on: ubuntu-latest
    needs: test-and-build
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ“¥ Descargar JAR
      uses: actions/download-artifact@v4
      with:
        name: application-jar
    
    - name: ðŸ“¥ Descargar archivos deployment
      uses: actions/download-artifact@v4
      with:
        name: deployment-files
    
    - name: ðŸ” Configurar AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: ðŸ“¦ Crear paquete deployment
      run: |
        ls -la
        echo "Listando artifacts descargados:"
        find . -name "*.jar" -type f
        mkdir -p deploy
        cp divtracker-be.jar deploy/ || cp application-jar/divtracker-be.jar deploy/ || find . -name "divtracker-be.jar" -exec cp {} deploy/ \;
        cp Procfile deploy/
        cp -r .ebextensions deploy/ 2>/dev/null || echo "No .ebextensions found"
        cd deploy
        zip -r ../divtracker-deployment.zip .
    
    - name: ðŸ·ï¸ Generar version label
      id: version
      run: |
        VERSION="v$(date +%Y%m%d_%H%M%S)-${GITHUB_SHA::8}"
        echo "version_label=$VERSION" >> $GITHUB_OUTPUT
    
    - name: â˜ï¸ Subir a S3
      run: |
        BUCKET_NAME="elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}"
        aws s3 cp divtracker-deployment.zip \
          s3://$BUCKET_NAME/divtracker/${{ steps.version.outputs.version_label }}.zip
    
    - name: ðŸ“‹ Crear versiÃ³n de aplicaciÃ³n
      run: |
        BUCKET_NAME="elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}"
        aws elasticbeanstalk create-application-version \
          --application-name divtracker-prod \
          --version-label ${{ steps.version.outputs.version_label }} \
          --source-bundle S3Bucket="$BUCKET_NAME",S3Key="divtracker/${{ steps.version.outputs.version_label }}.zip"
    
    - name: ðŸš€ Desplegar a Elastic Beanstalk
      run: |
        aws elasticbeanstalk update-environment \
          --application-name divtracker-prod \
          --environment-name divtracker-prod \
          --version-label ${{ steps.version.outputs.version_label }}
    
    - name: â³ Esperar deployment
      run: |
        echo "Esperando a que el entorno se actualice (timeout: 15 minutos)..."
        MAX_ATTEMPTS=45  # 45 intentos Ã— 20 segundos = 15 minutos
        ATTEMPT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          STATUS=$(aws elasticbeanstalk describe-environments \
            --application-name divtracker-prod \
            --environment-names divtracker-prod \
            --query 'Environments[0].Status' \
            --output text)
          
          HEALTH=$(aws elasticbeanstalk describe-environments \
            --application-name divtracker-prod \
            --environment-names divtracker-prod \
            --query 'Environments[0].Health' \
            --output text)
          
          echo "Intento $((ATTEMPT + 1))/$MAX_ATTEMPTS - Status: $STATUS, Health: $HEALTH"
          
          if [ "$STATUS" = "Ready" ]; then
            echo "âœ… Deployment completado! Status: $STATUS, Health: $HEALTH"
            exit 0
          fi
          
          if [ "$STATUS" = "Terminated" ] || [ "$STATUS" = "Terminating" ]; then
            echo "âŒ El entorno fue terminado durante el deployment"
            exit 1
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
          sleep 20
        done
        
        echo "âš ï¸ Timeout alcanzado despuÃ©s de 15 minutos"
        echo "El deployment puede seguir en progreso. Verifica manualmente en AWS Console."
        exit 1
    
    - name: ðŸŒ Obtener URL
      id: url
      run: |
        CNAME=$(aws elasticbeanstalk describe-environments \
          --application-name divtracker-prod \
          --environment-names divtracker-prod \
          --query 'Environments[0].CNAME' \
          --output text)
        echo "app_url=http://$CNAME" >> $GITHUB_OUTPUT
    
    - name: ðŸ¥ Health Check
      run: |
        echo "Esperando a que la aplicaciÃ³n estÃ© lista..."
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          ATTEMPT=$((ATTEMPT + 1))
          echo "Intento $ATTEMPT/$MAX_ATTEMPTS..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${{ steps.url.outputs.app_url }}/actuator/health || echo "000")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Deployment exitoso! La aplicaciÃ³n estÃ¡ respondiendo correctamente."
            exit 0
          fi
          
          echo "Health check respondiÃ³ con cÃ³digo: $HTTP_CODE"
          
          if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
            echo "Esperando 10 segundos antes del siguiente intento..."
            sleep 10
          fi
        done
        
        echo "âŒ Health check fallÃ³ despuÃ©s de $MAX_ATTEMPTS intentos (5 minutos)"
        echo "Ãšltima respuesta: HTTP $HTTP_CODE"
        exit 1
    
    - name: ðŸ“‹ Mostrar logs si falla
      if: failure()
      run: |
        echo "### ðŸ“‹ Ãšltimos logs de la aplicaciÃ³n:" >> $GITHUB_STEP_SUMMARY
        aws elasticbeanstalk describe-events \
          --application-name divtracker-prod \
          --environment-name divtracker-prod \
          --max-records 20 \
          --query 'Events[?Severity==`ERROR` || Severity==`WARN`].[EventDate,Severity,Message]' \
          --output table >> $GITHUB_STEP_SUMMARY || echo "No se pudieron obtener logs"
    
    - name: ðŸ“Š Resumen
      run: |
        echo "### ðŸš€ Deployment Exitoso" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **VersiÃ³n:** ${{ steps.version.outputs.version_label }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL:** ${{ steps.url.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Swagger:** ${{ steps.url.outputs.app_url }}/swagger-ui.html" >> $GITHUB_STEP_SUMMARY
        echo "- **Health:** ${{ steps.url.outputs.app_url }}/actuator/health" >> $GITHUB_STEP_SUMMARY
